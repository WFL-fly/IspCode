/******************************************************************************** alg_main.c** Copyright (C) 2019-2021 ZheJiang Dahua Technology CO.,LTD.** Author : Yan Hongsheng  <yan_hongsheng@dahuatech.com>* Version: V1.0.0  2019-9-1 Create** Desc: ISP接口实现** Modification:*    Date    :*    Revision:*    Author  :*    Contents:*******************************************************************************//* ========================================================================== *//*                             头文件区                                       *//* ========================================================================== */#include "aew.h"/* ========================================================================== *//*                          默认参数定义区                                    *//* ========================================================================== */#define DEFAULT_SEN_MAX_WIDTH  (512)  #define DEFAULT_SEN_MAX_HEIGHT (512)#define DEFAULT_ISP_CHANNEL_NUM (2)   //ispChannelNum#define DEFAULT_AGAIN_NUM (0)   //aGainNum/*#define DEFAULT_ISP_CHANNEL_NUM (1)   //ispChannelNum#define DEFAULT_AGAIN_NUM (0)   //aGainNum#define DEFAULT_ISP_CHANNEL_NUM (1)   //ispChannelNum#define DEFAULT_AGAIN_NUM (0)   //aGainNum#define DEFAULT_ISP_CHANNEL_NUM (1)   //ispChannelNum#define DEFAULT_AGAIN_NUM (0)   //aGainNum#define DEFAULT_ISP_CHANNEL_NUM (1)   //ispChannelNum#define DEFAULT_AGAIN_NUM (0)   //aGainNum#define DEFAULT_ISP_CHANNEL_NUM (1)   //ispChannelNum#define DEFAULT_AGAIN_NUM (0)   //aGainNum*//* ========================================================================== *//*                          函数声明区                                        *//* ========================================================================== */static Int32 ALG_ispCreateAllPara(ALG_IspParams* pIspParams);/* ========================================================================== *//*                          函数定义区                                        *//* ========================================================================== *//******************************************************************************** 函数名  : ALG_ispCreateAllPara* 描  述  : 所有外界交互参数赋值初始值* 输  入  : - pIspParams 交互参数结构体指针* 输  出  : 无。* 返回值  : OSA_SOK: 成功。*           OSA_EXX: 失败。*******************************************************************************/static Int32 ALG_ispCreateAllPara(ALG_IspParams* pIspParams){	Int32 ret = OSA_SOK;	int i=0;    /*******ALG_RunMode 参数*******/    pIspParams->ispRunMode = ALG_RUN_MODE_MANUAL;    /*******ALG_ConfigParams 参数*******/    pIspParams->configParams.sensorCfgParam.senMaxWidth = DEFAULT_SEN_MAX_WIDTH;         	pIspParams->configParams.sensorCfgParam.senMaxHeight = DEFAULT_SEN_MAX_HEIGHT;    pIspParams->configParams.sensorCfgParam.senFlipXFlag = 0;            pIspParams->configParams.sensorCfgParam.senFlipYFlag = 1;    pIspParams->configParams.sensorCfgParam.senRoiXFlag  = 0;    pIspParams->configParams.sensorCfgParam.senRoiYFlag  = 0;    pIspParams->configParams.sensorCfgParam.senOffsetXFlag = 0;    pIspParams->configParams.sensorCfgParam.senOffsetYFlag = 0;	pIspParams->configParams.sensorCfgParam.aGainNum       = DEFAULT_AGAIN_NUM;    for(i=0;i<16;i++)    {        pIspParams->configParams.sensorCfgParam.aGainTable[0] = 1.0;    }    pIspParams->configParams.sensorCfgParam.maxSensorGain = 1;    pIspParams->configParams.ispCfgParam.ispChannelNum =DEFAULT_ISP_CHANNEL_NUM;				           			pIspParams->configParams.ispCfgParam.dgcOffset = 0; 					pIspParams->configParams.ispCfgParam.tColorMin = 0;           		    pIspParams->configParams.ispCfgParam.tColorMax = 0;           		    pIspParams->configParams.ispCfgParam.grGainMin = 0.8;           		    pIspParams->configParams.ispCfgParam.grGainMax = 1.9;           		    pIspParams->configParams.ispCfgParam.gbGainMin = 0.8;           		    pIspParams->configParams.ispCfgParam.gbGainMax = 1.9;      pIspParams->configParams.ispCfgParam.minGain   = 1.0;    pIspParams->configParams.ispCfgParam.maxGain   = 1.0;    /******* ALG_CommonParams参数*******/    pIspParams->commonParams.pixelFormat = 0;	pIspParams->commonParams.ispChannelCnt = DEFAULT_ISP_CHANNEL_NUM;        /******* ALG_FpnFlashParam参数*******/    pIspParams->fpnParams.fpnFlashUpdate = 0;		    pIspParams->fpnParams.fpnFlashCnt = 1;    for(i=0;i<16;i++)    {        pIspParams->fpnParams.fpnFlashParam[i].blackOffset = 0;        pIspParams->fpnParams.fpnFlashParam[i].blackStats = NULL;        pIspParams->fpnParams.fpnFlashParam[i].grayStats = NULL;        pIspParams->fpnParams.fpnFlashParam[i].typeFlag = 0;        pIspParams->fpnParams.fpnFlashParam[i].columnNum = DEFAULT_SEN_MAX_WIDTH;    }    /******* ALG_SpcParams参数*******/    pIspParams->spcParams.badPixelData  = NULL;    pIspParams->spcParams.badColumnData = NULL;    pIspParams->spcParams.badColumnNum  = 0;    pIspParams->spcParams.badPixelNum   = 0;    /******* ALG_SeamParams参数*******/    pIspParams->seamParams.seamFlashData = NULL;		    pIspParams->seamParams.seamFlashCnt  = 0;		    pIspParams->seamParams.seamDataSize  = 0;    /******* ALG_RoiParams参数*******/    pIspParams->roiParams.roiWidth   = DEFAULT_SEN_MAX_WIDTH;         pIspParams->roiParams.roiHeight  = DEFAULT_SEN_MAX_HEIGHT;    pIspParams->roiParams.roiOffsetX = 0;     pIspParams->roiParams.roiOffsetY = 0;    /******* ALG_ReverseParams参数*******/    pIspParams->reverseParams.reverseX = 0;    pIspParams->reverseParams.reverseY = 0;    /******* ALG_BinningParams参数*******/    pIspParams->binningParams.binningX = 0;    pIspParams->binningParams.binningY = 0;    /******* ALG_BlcParams参数*******/    pIspParams->blcParams.blcMode   = ALG_AUTO_MODE_OFF;    pIspParams->blcParams.blcVal    = 0;	pIspParams->blcParams.blcUpdate = 0;    /******* ALG_ExpParams参数*******/    pIspParams->expParams.expMode   = ALG_AUTO_MODE_OFF;	pIspParams->expParams.expVal    = 5000;	pIspParams->expParams.expUpdate = 0;    /******* ALG_GainParams参数*******/    pIspParams->gainParams.digitalShift = 0;	pIspParams->gainParams.brightness   = 50;	pIspParams->gainParams.gainMode     = ALG_AUTO_MODE_OFF;    pIspParams->gainParams.gainVal      = 1.0;	pIspParams->gainParams.gainUpdate   = 0;    /******* ALG_AutoFunctionParams参数*******/	ALG_AutoFunctionParams	afParams;    pIspParams->afParams.targetBrightness = 50;	pIspParams->afParams.aeUpperLimit     = 1;	pIspParams->afParams.aeLowerLimit     = 1000000;	pIspParams->afParams.agUpperLimit     = 32;	pIspParams->afParams.agLowerLimit     = 1;	pIspParams->afParams.staRoiEnable     = 0;    pIspParams->afParams.staRoiOffsetX    = 0;    pIspParams->afParams.staRoiOffsetY    = 0;    pIspParams->afParams.staRoiWidth      = DEFAULT_SEN_MAX_WIDTH;    pIspParams->afParams.staRoiHeight     = DEFAULT_SEN_MAX_HEIGHT;    /******* ALG_WhiteBalanceParams参数*******/    pIspParams->wbParams.wbMode    = ALG_AUTO_MODE_OFF;    pIspParams->wbParams.redVal    = 1.0;    pIspParams->wbParams.greenVal  = 1.0;    pIspParams->wbParams.blueVal   = 1.0;    pIspParams->wbParams.wbUpdate  = 0;    /******* ALG_Lut2dParams参数*******/    pIspParams->lut2dParams.lutMode   = ALG_LUT2D_MODE_GAMMA;	pIspParams->lut2dParams.gammaVal  = 1.0;	pIspParams->lut2dParams.lutTable  = NULL;	pIspParams->lut2dParams.lutUpdate = 0;    /******* ALG_ContrastParams参数*******/    pIspParams->contrastParams.contrast  = 50;	pIspParams->contrastParams.threshold = 128;    /******* ALG_StitchParams参数*******/    pIspParams->stitchParams.stitchEnable = 0;	pIspParams->stitchParams.stitchDarkUpdate = 0;	pIspParams->stitchParams.stitchGrayUpdate = 0;	    pIspParams->stitchParams.stitchFlashUpdate = 0;    for(i=0;i<4;i++)    {        pIspParams->stitchParams.stitchFlashData[i] = NULL;    }	/************/		/* 链接接口参数到内部参数管理模块 */	ret |= AEW_paraConnect(PARA_AEW_ALG_ISP_PARAMS, (void*)pIspParams);	return ret;}/*****ALG_ispCreate :diyi******/int ispCreate(ALG_IspParams* pIspParams){	Int32 ret = OSA_SOK;		ret |= ALG_ispCreateAllPara(pIspParams);  //给所有接口参数赋值默认参数	ret |= APP_ispCreate();		if(OSA_SOK != ret)    {        printf("ALG_ispCreate failed!\n");        return OSA_SOK;    }	return OSA_SOK;}Int32 ispInit(void){	Int32 ret = OSA_SOK;		ret |= APP_ispInit();	//ret |= ALG_gainInit();	//ret |= ALG_fpnInit();		if(OSA_SOK != ret)    {        printf("ALG_ispCreate failed!\n");        return OSA_SOK;    }		return OSA_SOK;}Int32 ispRun(void){	APP_ispRun();    ALG_ispRun();    DRV_IspRun();	return OSA_SOK;}Int32 ispDelete(void){		return OSA_SOK;}